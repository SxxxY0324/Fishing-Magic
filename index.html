<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€æ˜æµè§ˆå™¨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="toolbar">
    <div class="drag-region"></div>

    <div class="site-buttons">
      <button class="site-btn active" data-url="https://www.douyin.com">æŠ–éŸ³</button>
      <button class="site-btn" data-url="https://www.bilibili.com">Bç«™</button>
      <button class="site-btn" data-url="https://my.4399.com/yxsgs/">ä¸‰å›½æ€</button>
    </div>

    <div class="opacity-control">
      <span class="opacity-label">é€æ˜åº¦</span>
      <input type="range" id="opacitySlider" min="20" max="100" value="50">
      <span id="opacityValue">50%</span>
    </div>

    <div class="volume-control">
      <span class="volume-icon" id="volumeIcon">ğŸ”‡</span>
      <input type="range" id="volumeSlider" min="0" max="100" value="0">
      <span id="volumeValue">0%</span>
    </div>

    <div class="window-controls">
      <button class="control-btn quick-hide" id="quickHideBtn" title="é™éŸ³å¹¶æœ€å°åŒ–">â¬</button>
      <button class="control-btn minimize" id="minimizeBtn">â”€</button>
      <button class="control-btn close" id="closeBtn">âœ•</button>
    </div>
  </div>

  <webview id="webview" src="https://www.douyin.com" allowpopups></webview>

  <script>
    const webview = document.getElementById('webview');
    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValue = document.getElementById('opacityValue');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeValue = document.getElementById('volumeValue');
    const volumeIcon = document.getElementById('volumeIcon');
    const siteButtons = document.querySelectorAll('.site-btn');
    const minimizeBtn = document.getElementById('minimizeBtn');
    const closeBtn = document.getElementById('closeBtn');

    // é€æ˜åº¦æ§åˆ¶
    opacitySlider.addEventListener('input', (e) => {
      const value = e.target.value;
      opacityValue.textContent = value + '%';
      window.electronAPI.setOpacity(value / 100);
    });

    // éŸ³é‡æ§åˆ¶
    function setVolume(value) {
      const volume = value / 100;
      volumeValue.textContent = value + '%';

      if (value == 0) {
        volumeIcon.textContent = 'ğŸ”‡';
      } else if (value < 50) {
        volumeIcon.textContent = 'ğŸ”‰';
      } else {
        volumeIcon.textContent = 'ğŸ”Š';
      }

      webview.executeJavaScript(`
        document.querySelectorAll('video, audio').forEach(el => el.volume = ${volume});
      `).catch(() => {});
    }

    volumeSlider.addEventListener('input', (e) => setVolume(e.target.value));

    volumeIcon.addEventListener('click', () => {
      if (volumeSlider.value > 0) {
        volumeSlider.dataset.prevValue = volumeSlider.value;
        volumeSlider.value = 0;
      } else {
        volumeSlider.value = volumeSlider.dataset.prevValue || 100;
      }
      setVolume(volumeSlider.value);
    });

    // é¡µé¢åŠ è½½å®Œæˆå’Œå¯¼èˆªåé‡æ–°è®¾ç½®éŸ³é‡
    webview.addEventListener('dom-ready', () => setVolume(volumeSlider.value));
    webview.addEventListener('did-navigate', () => setVolume(volumeSlider.value));
    webview.addEventListener('did-navigate-in-page', () => setVolume(volumeSlider.value));

    // åˆå§‹åŒ–ï¼šè®¾ç½®é»˜è®¤é€æ˜åº¦
    window.electronAPI.setOpacity(0.5);

    // ç½‘ç«™åˆ‡æ¢
    siteButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        siteButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        webview.src = btn.dataset.url;
      });
    });

    // çª—å£æ§åˆ¶
    const quickHideBtn = document.getElementById('quickHideBtn');

    quickHideBtn.addEventListener('click', () => {
      // åªåœ¨éé™éŸ³çŠ¶æ€ä¸‹ä¿å­˜å½“å‰éŸ³é‡
      if (volumeSlider.value > 0) {
        volumeSlider.dataset.prevValue = volumeSlider.value;
      }
      volumeSlider.value = 0;
      setVolume(0);
      window.electronAPI.minimizeWindow();
    });
    minimizeBtn.addEventListener('click', () => window.electronAPI.minimizeWindow());
    closeBtn.addEventListener('click', () => window.electronAPI.closeWindow());

    // ç©ºç™½åŒºåŸŸæ‹–æ‹½åŠŸèƒ½
    const dragRegion = document.querySelector('.drag-region');
    let isDragging = false;
    let startX = 0, startY = 0;
    let winBounds = null;

    dragRegion.addEventListener('mousedown', async (e) => {
      if (e.button !== 0) return;
      e.preventDefault();

      // è·å–å½“å‰çª—å£è¾¹ç•Œï¼ˆä½ç½®+å¤§å°ï¼‰
      winBounds = await window.electronAPI.getWindowBounds();
      startX = e.screenX;
      startY = e.screenY;
      isDragging = true;

      // åœ¨ window ä¸Šç›‘å¬ï¼Œç¡®ä¿é¼ æ ‡ç§»å‡ºçª—å£ä¹Ÿèƒ½å“åº”
      const onMouseMove = (e) => {
        if (!isDragging || !winBounds) return;
        const newX = winBounds.x + (e.screenX - startX);
        const newY = winBounds.y + (e.screenY - startY);
        // ä½¿ç”¨å›ºå®šçš„å®½é«˜ï¼Œé¿å…å¤§å°æ”¹å˜
        window.electronAPI.setWindowBounds(newX, newY, winBounds.width, winBounds.height);
      };

      const onMouseUp = () => {
        isDragging = false;
        winBounds = null;
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
      };

      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
    });

    // åŒå‡»ç©ºç™½åŒºåŸŸæœ€å°åŒ–å¹¶é™éŸ³
    dragRegion.addEventListener('dblclick', () => {
      isDragging = false;
      winBounds = null;
      // åªåœ¨éé™éŸ³çŠ¶æ€ä¸‹ä¿å­˜å½“å‰éŸ³é‡
      if (volumeSlider.value > 0) {
        volumeSlider.dataset.prevValue = volumeSlider.value;
      }
      volumeSlider.value = 0;
      setVolume(0);
      window.electronAPI.minimizeWindow();
    });
  </script>
</body>
</html>
